<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for runner/extensions/request.command.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">all files</a> / <a href="index.html">runner/extensions/</a> request.command.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">3.92% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>2/51</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/47</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/12</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">3.92% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>2/51</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191</td><td class="line-coverage quiet"><span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">var _ = require('lodash'),
    async = require('async'),
    sdk = require('postman-collection'),
    Requester = require('../../requester').Requester,
&nbsp;
    /**
     * Takes a list for Form-data parameters, and "resolve"s them.
     *
     * @param request
     * @param resolver
     * @param triggers
     * @param {Function} triggers.exception
     * @param callback
     */
    resolveFiles = <span class="fstat-no" title="function not covered" >function (request, resolver, triggers, cursor, callback) {</span>
<span class="cstat-no" title="statement not covered" >        var mode = _.get(request, 'body.mode'),</span>
            sourceReadable = _.isFunction(resolver &amp;&amp; resolver.createReadStream),
            data = mode &amp;&amp; _.get(request, 'body.' + mode);
&nbsp;
        // if there is no mode specified, or no data for the specified mode we cannot resolve anything!
        // @note that if source is not readable, there is no point reading anything, yet we need to warn that file
        // upload was not done. hence we will have to proceed even without an unreadable source
<span class="cstat-no" title="statement not covered" >        if (!data) { // we do not need to check `mode` here since false mode returns no `data`</span>
<span class="cstat-no" title="statement not covered" >            return callback(null, request);</span>
        }
&nbsp;
        // in this block, we simply use async.waterfall to ensure that all form of file reading is async. essentially,
        // we first determine the data mode and based on it pass the waterfall functions.
<span class="cstat-no" title="statement not covered" >        async.waterfall([async.constant(data), {</span>
            // form data parsing simply "enriches" all form parameters having file data type by replacing / setting the
            // value as a read stream
            formdata: <span class="fstat-no" title="function not covered" >function (formdata, next) {</span>
                // ensure that we only process the file type
<span class="cstat-no" title="statement not covered" >                async.eachSeries(_.filter(formdata.all(), {type: 'file'}), <span class="fstat-no" title="function not covered" >function (formparam, next) {</span></span>
<span class="cstat-no" title="statement not covered" >                    var stream;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >                    try {</span>
<span class="cstat-no" title="statement not covered" >                        sourceReadable &amp;&amp; formparam.src &amp;&amp; (stream = resolver.createReadStream(formparam.src));</span>
                    }
                    // eslint-disable-next-line no-empty
                    catch (e) { } // we do not need to forward error here since next line we throw warning
&nbsp;
<span class="cstat-no" title="statement not covered" >                    if (!stream) { // lack of stream also determines lack of `formparam.src` and source being readable</span>
                        // @todo - get cursor here.
<span class="cstat-no" title="statement not covered" >                        triggers.console(cursor, 'warn', 'unable to load form file for upload: "' + formparam.src + '"');</span>
                        // @todo - do enabled: false instead of removing it
<span class="cstat-no" title="statement not covered" >                        formdata.remove(formparam); </span>// remove from list since it will interfere with requester
                    }
                    // otherwise, replace the value with stream for making it usable in requester
                    else {
<span class="cstat-no" title="statement not covered" >                        formparam.value = stream;</span>
                    }
<span class="cstat-no" title="statement not covered" >                    next();</span>
                }, next);
            },
            // file data
            file: <span class="fstat-no" title="function not covered" >function (filedata, next) {</span>
<span class="cstat-no" title="statement not covered" >                var stream;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >                try {</span>
<span class="cstat-no" title="statement not covered" >                    sourceReadable &amp;&amp; filedata.src &amp;&amp; (stream = resolver.createReadStream(filedata.src));</span>
                }
                // eslint-disable-next-line no-empty
                catch (e) { }
&nbsp;
<span class="cstat-no" title="statement not covered" >                if (!stream) {</span>
<span class="cstat-no" title="statement not covered" >                    triggers.console(cursor, 'warn', 'unable to load raw file for upload: "' + filedata.src + '"');</span>
<span class="cstat-no" title="statement not covered" >                    filedata.value = null; </span>// ensure this does not mess with requester
<span class="cstat-no" title="statement not covered" >                    delete filedata.content; </span>// @todo - why content?
                }
                // stream is valid, so replace the value in data
                else {
                    // @todo: why is this not `value` like formdata. it would have made it easy to pass through
                    // a common logic
<span class="cstat-no" title="statement not covered" >                    filedata.content = stream;</span>
                }
&nbsp;
<span class="cstat-no" title="statement not covered" >                next();</span>
            }
        }[mode] || async.constant()], <span class="fstat-no" title="function not covered" >function (err) {</span>
            // just as a precaution, show the error in console. each resolver anyway should handle their own console
            // warnings.
            // @todo - get cursor here.
<span class="cstat-no" title="statement not covered" >            err &amp;&amp; triggers.console({}, 'warn', 'file data resolution error: ' + (err.message || err));</span>
<span class="cstat-no" title="statement not covered" >            callback(null, request); </span>// absorb the error since a console has been trigerred
        });
    };
&nbsp;
module.exports = {
    init: <span class="fstat-no" title="function not covered" >function (done) {</span>
<span class="cstat-no" title="statement not covered" >        var timeout = _.min([</span>
            _.get(this.options, 'timeout.request'),
            _.get(this.options, 'timeout.global')
        ]);
&nbsp;
&nbsp;
        // @todo - remove this when requester creation is offloaded to runner
<span class="cstat-no" title="statement not covered" >        if (this.options.requester &amp;&amp; this.options.requester.external === true) {</span>
<span class="cstat-no" title="statement not covered" >            this.requester = this.options.requester.instance;</span>
            // Just so we don't break the App, pull the file resolver out of the requester
<span class="cstat-no" title="statement not covered" >            this.options.fileResolver = _.get(this.requester, 'fileResolver');</span>
<span class="cstat-no" title="statement not covered" >            return done();</span>
        }
&nbsp;
<span class="cstat-no" title="statement not covered" >        !_.isFinite(timeout) &amp;&amp; (timeout = undefined);</span>
&nbsp;
        // @todo: get requester options and maybe store per-protocol requester
<span class="cstat-no" title="statement not covered" >        !this.requester &amp;&amp; (this.requester = new Requester(_.merge(this.options.requester, {</span>
            timeout: timeout || undefined
        })));
&nbsp;
<span class="cstat-no" title="statement not covered" >        done();</span>
    },
&nbsp;
    triggers: ['beforeRequest', 'request'],
&nbsp;
    process: {
        /**
         * @param {Object} payload
         * @param {Item} payload.item
         * @param {Object} payload.data
         * @param {VariableScope} payload.globals
         * @param {VariableScope} payload.environment
         * @param {Cursor} payload.coords
         * @param {Function} next
         *
         * @todo  validate payload
         */
        request: <span class="fstat-no" title="function not covered" >function (payload, next) {</span>
            // @todo - resolve variables in a more graceful way
            // @todo - no need to sync vatiables when SDK starts supporting resolution from scope directly
<span class="cstat-no" title="statement not covered" >            var item = new sdk.Item(payload.item.toObjectResolved(null,</span>
                [payload.data, payload.environment.syncVariablesTo({}), payload.globals.syncVariablesTo({})])),
&nbsp;
                abortOnError = _.has(payload, 'abortOnError') ? payload.abortOnError : this.options.abortOnError,
                self = this;
&nbsp;
<span class="cstat-no" title="statement not covered" >            async.waterfall([</span>
                // Process any authentication helpers in the request.
<span class="fstat-no" title="function not covered" >                function (cb) {</span>
                    // Re-parse the URL, because variables have been resolved now, and things might be moved around
<span class="cstat-no" title="statement not covered" >                    item.request.url = new (sdk.Url)(item.request.url.toString());</span>
<span class="cstat-no" title="statement not covered" >                    cb(null, item.request.authorize());</span>
                },
                // Handle file resolution
<span class="fstat-no" title="function not covered" >                function (request, cb) {</span>
<span class="cstat-no" title="statement not covered" >                    var resolver = _.get(self.options, 'fileResolver') ||</span>
                        // todo: remove this once apps give the options correctly
                        _.get(self.options, 'requester.fileResolver');
<span class="cstat-no" title="statement not covered" >                    resolveFiles(request, resolver, self.triggers, payload.coords, cb);</span>
                },
                // Send the request
<span class="fstat-no" title="function not covered" >                function (request, cb) {</span>
<span class="cstat-no" title="statement not covered" >                    var xhr,</span>
                        aborted;
&nbsp;
<span class="cstat-no" title="statement not covered" >                    item.request = request;</span>
&nbsp;
                    // Trigger the beforeRequest callback
<span class="cstat-no" title="statement not covered" >                    self.triggers.beforeRequest(null, payload.coords, item.request, payload.item, {</span>
                        abort: <span class="fstat-no" title="function not covered" >function () {</span>
<span class="cstat-no" title="statement not covered" >                            !aborted &amp;&amp; xhr &amp;&amp; xhr.abort();</span>
<span class="cstat-no" title="statement not covered" >                            aborted = true;</span>
                        }
                    });
&nbsp;
<span class="cstat-no" title="statement not covered" >                    if (aborted) {</span>
<span class="cstat-no" title="statement not covered" >                        return cb(new Error('runtime: request aborted'));</span>
                    }
&nbsp;
<span class="cstat-no" title="statement not covered" >                    xhr = self.requester.request(item, cb, self);</span>
                }
            ], <span class="fstat-no" title="function not covered" >function (err, legacyResponse, legacyRequest, response) {</span>
<span class="cstat-no" title="statement not covered" >                err = err || null;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >                this.triggers.request(err, payload.coords, new sdk.Response(response),</span>
                    item.request, payload.item,
                    // todo: remove these asap
                    legacyResponse, legacyRequest);
&nbsp;
<span class="cstat-no" title="statement not covered" >                next((err &amp;&amp; abortOnError) ? err : null, {</span>
                    response: response,
                    request: item.request,
                    legacyResponse: legacyResponse,
                    legacyRequest: legacyRequest
                }, err);
            }.bind(this));
        }
    }
};
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Oct 14 2016 17:26:49 GMT+0530 (IST)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
