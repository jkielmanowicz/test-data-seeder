<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for runner/extensions/event.command.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">all files</a> / <a href="index.html">runner/extensions/</a> event.command.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">3.57% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>2/56</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/72</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/15</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">3.7% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>2/54</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225</td><td class="line-coverage quiet"><span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">var _ = require('lodash'),
    async = require('async'),
    serialisedError = require('serialised-error'),
&nbsp;
    util = require('../util'),
    uvm = require('../../uvm'),
&nbsp;
    ASSERTION_FAILURE = 'AssertionFailure',
&nbsp;
    preProcessContext = <span class="fstat-no" title="function not covered" >function (context, trackables) {</span>
<span class="cstat-no" title="statement not covered" >        if (!(trackables &amp;&amp; trackables.length)) {</span>
<span class="cstat-no" title="statement not covered" >            return _.cloneDeep(context);</span>
        }
&nbsp;
<span class="cstat-no" title="statement not covered" >        var shadowContext = _.cloneDeep(_.omit(context, trackables));</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        _.forEach(trackables, <span class="fstat-no" title="function not covered" >function (key) {</span></span>
<span class="cstat-no" title="statement not covered" >            shadowContext[key] = _.isFunction(context[key].syncVariablesTo) ? context[key].syncVariablesTo({}) :</span>
                _.cloneDeep(context[key]);
        });
&nbsp;
<span class="cstat-no" title="statement not covered" >        return shadowContext;</span>
    },
&nbsp;
    postProcessContext = <span class="fstat-no" title="function not covered" >function (globals) {</span>  // This function determines whether the event needs to abort
<span class="cstat-no" title="statement not covered" >        var tests = globals &amp;&amp; globals.tests,</span>
            failures,
            error;
&nbsp;
<span class="cstat-no" title="statement not covered" >        _.forOwn(tests, <span class="fstat-no" title="function not covered" >function (result, test) {</span></span>
<span class="cstat-no" title="statement not covered" >            !result &amp;&amp; (failures || (failures = [])).push(test);</span>
        });
&nbsp;
<span class="cstat-no" title="statement not covered" >        if (failures) {</span>
<span class="cstat-no" title="statement not covered" >            error = new Error(failures.join(', '));</span>
<span class="cstat-no" title="statement not covered" >            error.name = ASSERTION_FAILURE;</span>
        }
<span class="cstat-no" title="statement not covered" >        return error ? serialisedError(error, true) : undefined;</span>
    };
&nbsp;
/**
 * Script execution extenion of the runner.
 * This module exposes processors for executing scripts before and after requests. Essentially, the processors are
 * itself not aware of other processors and simply allow running of a script and then queue a procesor as defined in
 * payload.
 *
 * Adds options
 * - suppressEventPropagation:Boolean [true]
 * - stopOnScriptError:Boolean [false]
 * - host:Object [undefined]
 */
module.exports = {
    init: <span class="fstat-no" title="function not covered" >function (done) {</span>
<span class="cstat-no" title="statement not covered" >        var run = this;</span>
&nbsp;
        // if this run object already has a host, we do not need to create one.
<span class="cstat-no" title="statement not covered" >        if (run.host) {</span>
<span class="cstat-no" title="statement not covered" >            return done();</span>
        }
&nbsp;
        // @todo - remove this when chrome app and electron host creation is offloaded to runner
<span class="cstat-no" title="statement not covered" >        if (run.options.host &amp;&amp; run.options.host.external === true) {</span>
<span class="cstat-no" title="statement not covered" >            run.host = run.options.host.instance;</span>
<span class="cstat-no" title="statement not covered" >            return done();</span>
        }
&nbsp;
        // create a new host to run scripts
<span class="cstat-no" title="statement not covered" >        uvm.createHost({}, _.merge({</span>
            // @todo - get the requires merged with run construction options
            requires: ['lodash', 'crypto-all', 'tv4', 'xml2js', 'atob', 'btoa', 'cheerio', 'backbone', 'buffer'],
            on: {
                exception: <span class="fstat-no" title="function not covered" >function () {</span> // @todo need uvm to bubble up log types and some passed during execute options
<span class="cstat-no" title="statement not covered" >                    run.triggers.exception.apply(run.triggers, arguments);</span>
                },
                // @todo this is supposed to fire just critical errors and stop run. but apparently it is firing
                // error even for events that shuld be ideally triggered as exception
                error: <span class="fstat-no" title="function not covered" >function () {</span>
<span class="cstat-no" title="statement not covered" >                    run.triggers.exception.apply(run.triggers, arguments);</span>
                },
                console: <span class="fstat-no" title="function not covered" >function () {</span> // @todo need uvm to bubble up log types and some passed during execute options
<span class="cstat-no" title="statement not covered" >                    run.triggers.console.apply(run.triggers, arguments);</span>
                }
            }
        }, run.options.host), <span class="fstat-no" title="function not covered" >function (err, host) {</span>
<span class="cstat-no" title="statement not covered" >            if (err) { <span class="cstat-no" title="statement not covered" >return done(err); </span>}</span>
            // store the host in run object for future use and move on
<span class="cstat-no" title="statement not covered" >            run.host = host;</span>
<span class="cstat-no" title="statement not covered" >            done();</span>
        });
    },
&nbsp;
    /**
     * This lists the name of the events that the script processors are likely to trigger
     *
     * @type {Array}
     */
    triggers: ['beforeScript', 'script', 'assertion', 'exception', 'console'],
&nbsp;
    process: {
        /**
         * This processors job is to do the following:
         * - trigger event by its name
         * - execute all scripts that the event listens to and return execution results
         *
         * @param {Object} payload
         * @param {String} payload.name
         * @param {Item} payload.item
         * @param {Object} [payload.context]
         * @param {Cursor} [payload.coords]
         * @param {Array.&lt;String&gt;} [payload.trackContext]
         * @param {Boolean} [payload.stopOnScriptError] - if set to true, then a synchronous error encountered during
         * execution of a script will stop executing any further scripts
         * @param {Boolean} [payload.abortOnFailure]
         * @param {Boolean} [payload.stopOnFailure]
         * @param {Function} next
         *
         * @note - in order to raise trigger for the entire event, ensure your extension has registered the triggers
         */
        event: <span class="fstat-no" title="function not covered" >function (payload, next) {</span>
<span class="cstat-no" title="statement not covered" >            var suppressEventPropagation = _.has(this.options, 'suppressEventPropagation') ?</span>
                    this.options.suppressEventPropagation : true,
                item = payload.item,
                eventName = payload.name,
                cursor = payload.coords,
                // the payload can have a list of variables to track from the context post execution, ensure that
                // those are accurately set
                track = _.isArray(payload.trackContext) &amp;&amp; _.isObject(payload.context) &amp;&amp;
                    // ensure that only those variables that are defined in the context are synced
                    payload.trackContext.filter(<span class="fstat-no" title="function not covered" >function (variable) {</span>
<span class="cstat-no" title="statement not covered" >                        return _.isObject(payload.context[variable]);</span>
                    }),
                stopOnScriptError = (_.has(payload, 'stopOnScriptError') ? payload.stopOnScriptError :
                    this.options.stopOnScriptError),
                abortOnError = (_.has(payload, 'abortOnError') ? payload.abortOnError : this.options.abortOnError),
&nbsp;
                // @todo: find a better home for this option processing
                abortOnFailure = payload.abortOnFailure,
                stopOnFailure = payload.stopOnFailure,
&nbsp;
                events;
&nbsp;
            // @todo: find a better place to code this so that event is not aware of such options
<span class="cstat-no" title="statement not covered" >            if (abortOnFailure) {</span>
<span class="cstat-no" title="statement not covered" >                abortOnError = true;</span>
            }
&nbsp;
            // validate the payload
<span class="cstat-no" title="statement not covered" >            if (!eventName) {</span>
<span class="cstat-no" title="statement not covered" >                return next(new Error('runner.extension~events: event payload is missing the event name.'));</span>
            }
<span class="cstat-no" title="statement not covered" >            if (!item) {</span>
<span class="cstat-no" title="statement not covered" >                return next(new Error('runner.extension~events: event payload is missing the triggered item.'));</span>
            }
&nbsp;
            // get the list of events to be executed. note that based on the `suppressEventPropagation` option, use
            // all inherited events or own events only
<span class="cstat-no" title="statement not covered" >            events = suppressEventPropagation ? item.events.listenersOwn(eventName) : item.events.listeners(eventName);</span>
&nbsp;
            // call the "before" event trigger by its event name.
            // at this point, the one who queued this event, must ensure that the trigger for it is defined in its
            // 'trigger' interface
<span class="cstat-no" title="statement not covered" >            this.triggers[_.camelCase('before-' + eventName)](null, cursor, events, item);</span>
&nbsp;
            // with all the event listeners in place, we now iterate on them and execute its scripts. post execution,
            // we accumulate the results in order to be passed on to the event callback trigger.
<span class="cstat-no" title="statement not covered" >            async.mapSeries(events, <span class="fstat-no" title="function not covered" >function (event, next) {</span></span>
                // in case the event has no script we bail out early
<span class="cstat-no" title="statement not covered" >                if (!event.script) {</span>
<span class="cstat-no" title="statement not covered" >                    return next(null, {event: event});</span>
                }
&nbsp;
                // get access to the script from the event.
<span class="cstat-no" title="statement not covered" >                var script = event.script;</span>
&nbsp;
                // trigger the "beforeScript" callback
<span class="cstat-no" title="statement not covered" >                this.triggers.beforeScript(null, cursor, script, event, item);</span>
&nbsp;
                // finally execute the script
<span class="cstat-no" title="statement not covered" >                this.host.execute(script.toSource(), {</span>
                    masked: {
                        scriptType: eventName, // @todo TBD should this come as payload?
                        cursor: cursor,
                        stopOnScriptError: stopOnScriptError
                    },
                    // while passing value of ctx, we directly use payload.ctx and not make a local copy to ensure we
                    // have the live copy
                    globals: preProcessContext(payload.context, track)
                }, <span class="fstat-no" title="function not covered" >function (err, result) {</span>
                     // electron IPC does not bubble errors to the browser process, so we serialize it here.
<span class="cstat-no" title="statement not covered" >                    err &amp;&amp; (err = serialisedError(err, true));</span>
&nbsp;
                    // if it is defined that certain variables are to be synced back to result, we do the same
<span class="cstat-no" title="statement not covered" >                    track &amp;&amp; result &amp;&amp; result.globals &amp;&amp; track.forEach(<span class="fstat-no" title="function not covered" >function (variable) {</span></span>
<span class="cstat-no" title="statement not covered" >                        if (!_.isObject(result.globals[variable])) { <span class="cstat-no" title="statement not covered" >return; </span>}</span>
&nbsp;
                        // ensure that variablescope is treated accordingly
<span class="cstat-no" title="statement not covered" >                        _.isFunction(payload.context[variable].syncVariablesFrom) ?</span>
                            payload.context[variable].syncVariablesFrom(result.globals[variable]) :
                            util.syncObject(payload.context[variable], result.globals[variable]);
                    });
&nbsp;
                    // Get the failures. If there was an error running the script itself, that takes precedence
<span class="cstat-no" title="statement not covered" >                    if (!err &amp;&amp; (abortOnFailure || stopOnFailure)) {</span>
<span class="cstat-no" title="statement not covered" >                        err = postProcessContext(result.globals);</span>
                    }
                    // now that this script is done executing, we trigger the event and move to the next script
<span class="cstat-no" title="statement not covered" >                    this.triggers.script(err || null, cursor, result, script, event, item);</span>
&nbsp;
                    // move to next script and pass on the results for accumulation
<span class="cstat-no" title="statement not covered" >                    next(((stopOnScriptError || abortOnError || stopOnFailure) &amp;&amp; err) ? err : null, _.assign({</span>
                        event: event,
                        script: script,
                        result: result
                    }, err &amp;&amp; {error: err})); // we use assign here to avoid needless error property
                }.bind(this));
&nbsp;
            }.bind(this), <span class="fstat-no" title="function not covered" >function (err, results) {</span>
                // trigger the event completion callback
<span class="cstat-no" title="statement not covered" >                this.triggers[eventName](null, cursor, results, item);</span>
<span class="cstat-no" title="statement not covered" >                next((abortOnError &amp;&amp; err) ? err : null, results, err);</span>
            }.bind(this));
        }
    }
};
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Oct 14 2016 17:26:49 GMT+0530 (IST)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
